const { MessageEmbed } = require('discord.js');
const Musixmatch = require('@raflymln/musixmatch-lyrics');
module.exports = (client) => {
    /*
  PERMISSION LEVEL FUNCTION

  This is a very basic permission system for commands which uses "levels"
  "spaces" are intentionally left black so you can add them if you want.
  NEVER GIVE ANYONE BUT OWNER THE LEVEL 10! By default this can run any
  command including the VERY DANGEROUS `eval` and `exec` commands!

  */
    client.permlevel = (message) => {
        let permlvl = 0;
        const permOrder = client.config.permLevels
            .slice(0)
            .sort((p, c) => (p.level < c.level ? 1 : -1));
        while (permOrder.length) {
            const currentLevel = permOrder.shift();
            if (message.guild && currentLevel.guildOnly)
                continue;
            if (currentLevel.check(message)) {
                permlvl = currentLevel.level;
                break;
            }
        }
        return permlvl;
    };
    /*
  GUILD SETTINGS FUNCTION

  This function merges the default settings (from config.defaultSettings) with any
  guild override you might have for particular guild. If no overrides are present,
  the default settings are used.

  */
    // THIS IS HERE BECAUSE SOME PEOPLE DELETE ALL THE GUILD SETTINGS
    // And then they're stuck because the default settings are also gone.
    // So if you do that, you're resetting your defaults. Congrats.
    const defaultSettings = {
        prefix: '!',
        modLogChannel: 'mod-log',
        modRole: 'Moderator',
        adminRole: 'Administrator',
        systemNotice: 'true',
        welcomeChannel: 'welcome',
        welcomeMessage: 'Say hello to {{user}}, everyone! We all need a warm welcome sometimes :D',
        welcomeEnabled: 'false',
        reddit: 'false',
        musicChannelId: '',
        musicMsgId: '',
        lyricsChannelId: '',
    };
    // getSettings merges the client defaults with the guild settings. guild settings in
    // enmap should only have *unique* overrides that are different from defaults.
    client.getSettings = (guild) => {
        client.settings.ensure('default', defaultSettings);
        if (!guild)
            return client.settings.get('default');
        const guildConf = client.settings.get(guild.id) || {};
        // This "..." thing is the "Spread Operator". It's awesome!
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax
        return { ...client.settings.get('default'), ...guildConf };
    };
    /*
  SINGLE-LINE AWAITMESSAGE

  A simple way to grab a single reply, from the user that initiated
  the command. Useful to get "precisions" on certain things...

  USAGE

  const response = await client.awaitReply(msg, "Favourite Color?");
  msg.reply(`Oh, I really love ${response} too!`);

  */
    client.awaitReply = async (msg, question, limit = 60000) => {
        const filter = (m) => m.author.id === msg.author.id;
        await msg.channel.send(question);
        try {
            const collected = await msg.channel.awaitMessages(filter, {
                max: 1,
                time: limit,
                errors: ['time'],
            });
            return collected.first().content;
        }
        catch (e) {
            return false;
        }
    };
    /*
  MESSAGE CLEAN FUNCTION

  "Clean" removes @everyone pings, as well as tokens, and makes code blocks
  escaped so they're shown more easily. As a bonus it resolves promises
  and stringifies objects!
  This is mostly only used by the Eval and Exec commands.
  */
    client.clean = async (client, text) => {
        if (text && text.constructor.name == 'Promise')
            text = await text;
        if (typeof text !== 'string')
            text = require('util').inspect(text, { depth: 1 });
        text = text
            .replace(/`/g, '`' + String.fromCharCode(8203))
            .replace(/@/g, '@' + String.fromCharCode(8203))
            .replace(client.token, 'mfa.VkO_2G4Qv3T--NO--lWetW_tjND--TOKEN--QFTm6YGtzq9PH--4U--tG0');
        return text;
    };
    client.loadCommand = (commandName) => {
        try {
            client.logger.log(`Loading Command: ${commandName}`);
            const props = require(`../commands/${commandName}`);
            if (props.init) {
                props.init(client);
            }
            client.commands.set(props.help.name, props);
            props.conf.aliases.forEach((alias) => {
                client.aliases.set(alias, props.help.name);
            });
            return false;
        }
        catch (e) {
            return `Unable to load command ${commandName}: ${e}`;
        }
    };
    client.unloadCommand = async (commandName) => {
        let command;
        if (client.commands.has(commandName)) {
            command = client.commands.get(commandName);
        }
        else if (client.aliases.has(commandName)) {
            command = client.commands.get(client.aliases.get(commandName));
        }
        if (!command)
            return `The command \`${commandName}\` doesn"t seem to exist, nor is it an alias. Try again!`;
        if (command.shutdown) {
            await command.shutdown(client);
        }
        const mod = require.cache[require.resolve(`../commands/${command.help.name}`)];
        delete require.cache[require.resolve(`../commands/${command.help.name}.js`)];
        for (let i = 0; i < mod.parent.children.length; i++) {
            if (mod.parent.children[i] === mod) {
                mod.parent.children.splice(i, 1);
                break;
            }
        }
        return false;
    };
    /* Music player funtcions */
    client.musicUserCheck = (client, message, queueNeeded) => {
        if (!message.member.voice.channel) {
            message.channel.bulkDelete(1).then(() => {
                message.channel
                    .send(`You're not in a voice channel !`)
                    .then((msg) => msg.delete({ timeout: 3000 }));
            });
            return true;
        }
        if (message.guild.me.voice.channel &&
            message.member.voice.channel.id !==
                message.guild.me.voice.channel.id) {
            message.channel.bulkDelete(1).then(() => {
                message.channel
                    .send(`You are not in the same voice channel!`)
                    .then((msg) => msg.delete({ timeout: 3000 }));
            });
            return true;
        }
        if (queueNeeded) {
            if (!client.player.getQueue(message)) {
                message.channel.bulkDelete(1).then(() => {
                    message.channel
                        .send(`No music currently playing !`)
                        .then((msg) => msg.delete({ timeout: 3000 }));
                });
                return true;
            }
        }
        return false;
    };
    client.clearBanner = async (client, message) => {
        let channel = await client.channels.fetch(message.settings.musicChannelId);
        let msg = await channel.messages.fetch(message.settings.musicMsgId);
        const embed = new MessageEmbed()
            .setTitle('No song playing currently')
            .setImage('https://bestbots.today/wp-content/uploads/2020/04/Music.png')
            .setFooter(`Prefix for this server is: ${message.settings.prefix}`)
            .setColor(message.settings.embedColor);
        msg.edit('Queue:\n', embed);
    };
    client.queueMessage = (queue) => {
        let text = 'Queue:\n';
        for (let i = queue.tracks.length - 1; i >= 1; i--) {
            text += `${i}. ${queue.tracks[i].title}\n`;
        }
        return text;
    };
    client.lyrics = async (songname) => {
        try {
            let lyrics = await Musixmatch.find(songname);
            return await lyrics.lyrics;
        }
        catch (e) {
            return e;
        }
    };
    /* MISCELANEOUS NON-CRITICAL FUNCTIONS */
    // EXTENDING NATIVE TYPES IS BAD PRACTICE. Why? Because if JavaScript adds this
    // later, this conflicts with native code. Also, if some other lib you use does
    // this, a conflict also occurs. KNOWING THIS however, the following 2 methods
    // are, we feel, very useful in code.
    // <String>.toPropercase() returns a proper-cased string such as:
    // "Mary had a little lamb".toProperCase() returns "Mary Had A Little Lamb"
    Object.defineProperty(String.prototype, 'toProperCase', {
        value: function () {
            return this.replace(/([^\W_]+[^\s-]*) */g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        },
    });
    // <Array>.random() returns a single random element from an array
    // [1, 2, 3, 4, 5].random() can return 1, 2, 3, 4 or 5.
    Object.defineProperty(Array.prototype, 'random', {
        value: function () {
            return this[Math.floor(Math.random() * this.length)];
        },
    });
    // `await client.wait(1000);` to "pause" for 1 second.
    client.wait = require('util').promisify(setTimeout);
    // These 2 process methods will catch exceptions and give *more details* about the error and stack trace.
    process.on('uncaughtException', (err) => {
        if (!err || !err.stack)
            return;
        const errorMsg = err.stack.replace(new RegExp(`${__dirname}/`, 'g'), './');
        client.logger.error(`Uncaught Exception: ${errorMsg}`);
        console.error(err);
        // Always best practice to let the code crash on uncaught exceptions.
        // Because you should be catching them anyway.
        process.exit(1);
    });
    process.on('unhandledRejection', (err) => {
        client.logger.error(`Unhandled rejection: ${err}`);
        console.error(err);
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21vZHVsZXMvZnVuY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDL0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFFMUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFO0lBQ3hCOzs7Ozs7OztJQVFBO0lBQ0EsTUFBTSxDQUFDLFNBQVMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzNCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztRQUVoQixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVU7YUFDckMsS0FBSyxDQUFDLENBQUMsQ0FBQzthQUNSLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVsRCxPQUFPLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDckIsTUFBTSxZQUFZLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3ZDLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxZQUFZLENBQUMsU0FBUztnQkFBRSxTQUFTO1lBQ3RELElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDN0IsT0FBTyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7Z0JBQzdCLE1BQU07YUFDVDtTQUNKO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQyxDQUFDO0lBRUY7Ozs7Ozs7SUFPQTtJQUVBLGlFQUFpRTtJQUNqRSxxRUFBcUU7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QUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUVwRCx5R0FBeUc7SUFDekcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ3BDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSztZQUFFLE9BQU87UUFDL0IsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQzlCLElBQUksTUFBTSxDQUFDLEdBQUcsU0FBUyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQ2hDLElBQUksQ0FDUCxDQUFDO1FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDdkQsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQixxRUFBcUU7UUFDckUsOENBQThDO1FBQzlDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDckMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDbkQsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgTWVzc2FnZUVtYmVkIH0gPSByZXF1aXJlKCdkaXNjb3JkLmpzJyk7XG5jb25zdCBNdXNpeG1hdGNoID0gcmVxdWlyZSgnQHJhZmx5bWxuL211c2l4bWF0Y2gtbHlyaWNzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gKGNsaWVudCkgPT4ge1xuICAgIC8qXG4gIFBFUk1JU1NJT04gTEVWRUwgRlVOQ1RJT05cblxuICBUaGlzIGlzIGEgdmVyeSBiYXNpYyBwZXJtaXNzaW9uIHN5c3RlbSBmb3IgY29tbWFuZHMgd2hpY2ggdXNlcyBcImxldmVsc1wiXG4gIFwic3BhY2VzXCIgYXJlIGludGVudGlvbmFsbHkgbGVmdCBibGFjayBzbyB5b3UgY2FuIGFkZCB0aGVtIGlmIHlvdSB3YW50LlxuICBORVZFUiBHSVZFIEFOWU9ORSBCVVQgT1dORVIgVEhFIExFVkVMIDEwISBCeSBkZWZhdWx0IHRoaXMgY2FuIHJ1biBhbnlcbiAgY29tbWFuZCBpbmNsdWRpbmcgdGhlIFZFUlkgREFOR0VST1VTIGBldmFsYCBhbmQgYGV4ZWNgIGNvbW1hbmRzIVxuXG4gICovXG4gICAgY2xpZW50LnBlcm1sZXZlbCA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgIGxldCBwZXJtbHZsID0gMDtcblxuICAgICAgICBjb25zdCBwZXJtT3JkZXIgPSBjbGllbnQuY29uZmlnLnBlcm1MZXZlbHNcbiAgICAgICAgICAgIC5zbGljZSgwKVxuICAgICAgICAgICAgLnNvcnQoKHAsIGMpID0+IChwLmxldmVsIDwgYy5sZXZlbCA/IDEgOiAtMSkpO1xuXG4gICAgICAgIHdoaWxlIChwZXJtT3JkZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50TGV2ZWwgPSBwZXJtT3JkZXIuc2hpZnQoKTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLmd1aWxkICYmIGN1cnJlbnRMZXZlbC5ndWlsZE9ubHkpIGNvbnRpbnVlO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRMZXZlbC5jaGVjayhtZXNzYWdlKSkge1xuICAgICAgICAgICAgICAgIHBlcm1sdmwgPSBjdXJyZW50TGV2ZWwubGV2ZWw7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBlcm1sdmw7XG4gICAgfTtcblxuICAgIC8qXG4gIEdVSUxEIFNFVFRJTkdTIEZVTkNUSU9OXG5cbiAgVGhpcyBmdW5jdGlvbiBtZXJnZXMgdGhlIGRlZmF1bHQgc2V0dGluZ3MgKGZyb20gY29uZmlnLmRlZmF1bHRTZXR0aW5ncykgd2l0aCBhbnlcbiAgZ3VpbGQgb3ZlcnJpZGUgeW91IG1pZ2h0IGhhdmUgZm9yIHBhcnRpY3VsYXIgZ3VpbGQuIElmIG5vIG92ZXJyaWRlcyBhcmUgcHJlc2VudCxcbiAgdGhlIGRlZmF1bHQgc2V0dGluZ3MgYXJlIHVzZWQuXG5cbiAgKi9cblxuICAgIC8vIFRISVMgSVMgSEVSRSBCRUNBVVNFIFNPTUUgUEVPUExFIERFTEVURSBBTEwgVEhFIEdVSUxEIFNFVFRJTkdTXG4gICAgLy8gQW5kIHRoZW4gdGhleSdyZSBzdHVjayBiZWNhdXNlIHRoZSBkZWZhdWx0IHNldHRpbmdzIGFyZSBhbHNvIGdvbmUuXG4gICAgLy8gU28gaWYgeW91IGRvIHRoYXQsIHlvdSdyZSByZXNldHRpbmcgeW91ciBkZWZhdWx0cy4gQ29uZ3JhdHMuXG4gICAgY29uc3QgZGVmYXVsdFNldHRpbmdzID0ge1xuICAgICAgICBwcmVmaXg6ICchJyxcbiAgICAgICAgbW9kTG9nQ2hhbm5lbDogJ21vZC1sb2cnLFxuICAgICAgICBtb2RSb2xlOiAnTW9kZXJhdG9yJyxcbiAgICAgICAgYWRtaW5Sb2xlOiAnQWRtaW5pc3RyYXRvcicsXG4gICAgICAgIHN5c3RlbU5vdGljZTogJ3RydWUnLFxuICAgICAgICB3ZWxjb21lQ2hhbm5lbDogJ3dlbGNvbWUnLFxuICAgICAgICB3ZWxjb21lTWVzc2FnZTpcbiAgICAgICAgICAgICdTYXkgaGVsbG8gdG8ge3t1c2VyfX0sIGV2ZXJ5b25lISBXZSBhbGwgbmVlZCBhIHdhcm0gd2VsY29tZSBzb21ldGltZXMgOkQnLFxuICAgICAgICB3ZWxjb21lRW5hYmxlZDogJ2ZhbHNlJyxcbiAgICAgICAgcmVkZGl0OiAnZmFsc2UnLFxuICAgICAgICBtdXNpY0NoYW5uZWxJZDogJycsXG4gICAgICAgIG11c2ljTXNnSWQ6ICcnLFxuICAgICAgICBseXJpY3NDaGFubmVsSWQ6ICcnLFxuICAgIH07XG5cbiAgICAvLyBnZXRTZXR0aW5ncyBtZXJnZXMgdGhlIGNsaWVudCBkZWZhdWx0cyB3aXRoIHRoZSBndWlsZCBzZXR0aW5ncy4gZ3VpbGQgc2V0dGluZ3MgaW5cbiAgICAvLyBlbm1hcCBzaG91bGQgb25seSBoYXZlICp1bmlxdWUqIG92ZXJyaWRlcyB0aGF0IGFyZSBkaWZmZXJlbnQgZnJvbSBkZWZhdWx0cy5cbiAgICBjbGllbnQuZ2V0U2V0dGluZ3MgPSAoZ3VpbGQpID0+IHtcbiAgICAgICAgY2xpZW50LnNldHRpbmdzLmVuc3VyZSgnZGVmYXVsdCcsIGRlZmF1bHRTZXR0aW5ncyk7XG4gICAgICAgIGlmICghZ3VpbGQpIHJldHVybiBjbGllbnQuc2V0dGluZ3MuZ2V0KCdkZWZhdWx0Jyk7XG4gICAgICAgIGNvbnN0IGd1aWxkQ29uZiA9IGNsaWVudC5zZXR0aW5ncy5nZXQoZ3VpbGQuaWQpIHx8IHt9O1xuICAgICAgICAvLyBUaGlzIFwiLi4uXCIgdGhpbmcgaXMgdGhlIFwiU3ByZWFkIE9wZXJhdG9yXCIuIEl0J3MgYXdlc29tZSFcbiAgICAgICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL1NwcmVhZF9zeW50YXhcbiAgICAgICAgcmV0dXJuIHsgLi4uY2xpZW50LnNldHRpbmdzLmdldCgnZGVmYXVsdCcpLCAuLi5ndWlsZENvbmYgfTtcbiAgICB9O1xuXG4gICAgLypcbiAgU0lOR0xFLUxJTkUgQVdBSVRNRVNTQUdFXG5cbiAgQSBzaW1wbGUgd2F5IHRvIGdyYWIgYSBzaW5nbGUgcmVwbHksIGZyb20gdGhlIHVzZXIgdGhhdCBpbml0aWF0ZWRcbiAgdGhlIGNvbW1hbmQuIFVzZWZ1bCB0byBnZXQgXCJwcmVjaXNpb25zXCIgb24gY2VydGFpbiB0aGluZ3MuLi5cblxuICBVU0FHRVxuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2xpZW50LmF3YWl0UmVwbHkobXNnLCBcIkZhdm91cml0ZSBDb2xvcj9cIik7XG4gIG1zZy5yZXBseShgT2gsIEkgcmVhbGx5IGxvdmUgJHtyZXNwb25zZX0gdG9vIWApO1xuXG4gICovXG4gICAgY2xpZW50LmF3YWl0UmVwbHkgPSBhc3luYyAobXNnLCBxdWVzdGlvbiwgbGltaXQgPSA2MDAwMCkgPT4ge1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSAobSkgPT4gbS5hdXRob3IuaWQgPT09IG1zZy5hdXRob3IuaWQ7XG4gICAgICAgIGF3YWl0IG1zZy5jaGFubmVsLnNlbmQocXVlc3Rpb24pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY29sbGVjdGVkID0gYXdhaXQgbXNnLmNoYW5uZWwuYXdhaXRNZXNzYWdlcyhmaWx0ZXIsIHtcbiAgICAgICAgICAgICAgICBtYXg6IDEsXG4gICAgICAgICAgICAgICAgdGltZTogbGltaXQsXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBbJ3RpbWUnXSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZC5maXJzdCgpLmNvbnRlbnQ7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvKlxuICBNRVNTQUdFIENMRUFOIEZVTkNUSU9OXG5cbiAgXCJDbGVhblwiIHJlbW92ZXMgQGV2ZXJ5b25lIHBpbmdzLCBhcyB3ZWxsIGFzIHRva2VucywgYW5kIG1ha2VzIGNvZGUgYmxvY2tzXG4gIGVzY2FwZWQgc28gdGhleSdyZSBzaG93biBtb3JlIGVhc2lseS4gQXMgYSBib251cyBpdCByZXNvbHZlcyBwcm9taXNlc1xuICBhbmQgc3RyaW5naWZpZXMgb2JqZWN0cyFcbiAgVGhpcyBpcyBtb3N0bHkgb25seSB1c2VkIGJ5IHRoZSBFdmFsIGFuZCBFeGVjIGNvbW1hbmRzLlxuICAqL1xuICAgIGNsaWVudC5jbGVhbiA9IGFzeW5jIChjbGllbnQsIHRleHQpID0+IHtcbiAgICAgICAgaWYgKHRleHQgJiYgdGV4dC5jb25zdHJ1Y3Rvci5uYW1lID09ICdQcm9taXNlJykgdGV4dCA9IGF3YWl0IHRleHQ7XG4gICAgICAgIGlmICh0eXBlb2YgdGV4dCAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICB0ZXh0ID0gcmVxdWlyZSgndXRpbCcpLmluc3BlY3QodGV4dCwgeyBkZXB0aDogMSB9KTtcblxuICAgICAgICB0ZXh0ID0gdGV4dFxuICAgICAgICAgICAgLnJlcGxhY2UoL2AvZywgJ2AnICsgU3RyaW5nLmZyb21DaGFyQ29kZSg4MjAzKSlcbiAgICAgICAgICAgIC5yZXBsYWNlKC9AL2csICdAJyArIFN0cmluZy5mcm9tQ2hhckNvZGUoODIwMykpXG4gICAgICAgICAgICAucmVwbGFjZShcbiAgICAgICAgICAgICAgICBjbGllbnQudG9rZW4sXG4gICAgICAgICAgICAgICAgJ21mYS5Wa09fMkc0UXYzVC0tTk8tLWxXZXRXX3RqTkQtLVRPS0VOLS1RRlRtNllHdHpxOVBILS00VS0tdEcwJ1xuICAgICAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9O1xuXG4gICAgY2xpZW50LmxvYWRDb21tYW5kID0gKGNvbW1hbmROYW1lKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjbGllbnQubG9nZ2VyLmxvZyhgTG9hZGluZyBDb21tYW5kOiAke2NvbW1hbmROYW1lfWApO1xuICAgICAgICAgICAgY29uc3QgcHJvcHMgPSByZXF1aXJlKGAuLi9jb21tYW5kcy8ke2NvbW1hbmROYW1lfWApO1xuICAgICAgICAgICAgaWYgKHByb3BzLmluaXQpIHtcbiAgICAgICAgICAgICAgICBwcm9wcy5pbml0KGNsaWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbGllbnQuY29tbWFuZHMuc2V0KHByb3BzLmhlbHAubmFtZSwgcHJvcHMpO1xuICAgICAgICAgICAgcHJvcHMuY29uZi5hbGlhc2VzLmZvckVhY2goKGFsaWFzKSA9PiB7XG4gICAgICAgICAgICAgICAgY2xpZW50LmFsaWFzZXMuc2V0KGFsaWFzLCBwcm9wcy5oZWxwLm5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJldHVybiBgVW5hYmxlIHRvIGxvYWQgY29tbWFuZCAke2NvbW1hbmROYW1lfTogJHtlfWA7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY2xpZW50LnVubG9hZENvbW1hbmQgPSBhc3luYyAoY29tbWFuZE5hbWUpID0+IHtcbiAgICAgICAgbGV0IGNvbW1hbmQ7XG4gICAgICAgIGlmIChjbGllbnQuY29tbWFuZHMuaGFzKGNvbW1hbmROYW1lKSkge1xuICAgICAgICAgICAgY29tbWFuZCA9IGNsaWVudC5jb21tYW5kcy5nZXQoY29tbWFuZE5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKGNsaWVudC5hbGlhc2VzLmhhcyhjb21tYW5kTmFtZSkpIHtcbiAgICAgICAgICAgIGNvbW1hbmQgPSBjbGllbnQuY29tbWFuZHMuZ2V0KGNsaWVudC5hbGlhc2VzLmdldChjb21tYW5kTmFtZSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY29tbWFuZClcbiAgICAgICAgICAgIHJldHVybiBgVGhlIGNvbW1hbmQgXFxgJHtjb21tYW5kTmFtZX1cXGAgZG9lc25cInQgc2VlbSB0byBleGlzdCwgbm9yIGlzIGl0IGFuIGFsaWFzLiBUcnkgYWdhaW4hYDtcblxuICAgICAgICBpZiAoY29tbWFuZC5zaHV0ZG93bikge1xuICAgICAgICAgICAgYXdhaXQgY29tbWFuZC5zaHV0ZG93bihjbGllbnQpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1vZCA9XG4gICAgICAgICAgICByZXF1aXJlLmNhY2hlW3JlcXVpcmUucmVzb2x2ZShgLi4vY29tbWFuZHMvJHtjb21tYW5kLmhlbHAubmFtZX1gKV07XG4gICAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW1xuICAgICAgICAgICAgcmVxdWlyZS5yZXNvbHZlKGAuLi9jb21tYW5kcy8ke2NvbW1hbmQuaGVscC5uYW1lfS5qc2ApXG4gICAgICAgIF07XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbW9kLnBhcmVudC5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKG1vZC5wYXJlbnQuY2hpbGRyZW5baV0gPT09IG1vZCkge1xuICAgICAgICAgICAgICAgIG1vZC5wYXJlbnQuY2hpbGRyZW4uc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuXG4gICAgLyogTXVzaWMgcGxheWVyIGZ1bnRjaW9ucyAqL1xuXG4gICAgY2xpZW50Lm11c2ljVXNlckNoZWNrID0gKGNsaWVudCwgbWVzc2FnZSwgcXVldWVOZWVkZWQpID0+IHtcbiAgICAgICAgaWYgKCFtZXNzYWdlLm1lbWJlci52b2ljZS5jaGFubmVsKSB7XG4gICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWwuYnVsa0RlbGV0ZSgxKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWxcbiAgICAgICAgICAgICAgICAgICAgLnNlbmQoYFlvdSdyZSBub3QgaW4gYSB2b2ljZSBjaGFubmVsICFgKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigobXNnKSA9PiBtc2cuZGVsZXRlKHsgdGltZW91dDogMzAwMCB9KSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIG1lc3NhZ2UuZ3VpbGQubWUudm9pY2UuY2hhbm5lbCAmJlxuICAgICAgICAgICAgbWVzc2FnZS5tZW1iZXIudm9pY2UuY2hhbm5lbC5pZCAhPT1cbiAgICAgICAgICAgICAgICBtZXNzYWdlLmd1aWxkLm1lLnZvaWNlLmNoYW5uZWwuaWRcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWwuYnVsa0RlbGV0ZSgxKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWxcbiAgICAgICAgICAgICAgICAgICAgLnNlbmQoYFlvdSBhcmUgbm90IGluIHRoZSBzYW1lIHZvaWNlIGNoYW5uZWwhYClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKG1zZykgPT4gbXNnLmRlbGV0ZSh7IHRpbWVvdXQ6IDMwMDAgfSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocXVldWVOZWVkZWQpIHtcbiAgICAgICAgICAgIGlmICghY2xpZW50LnBsYXllci5nZXRRdWV1ZShtZXNzYWdlKSkge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UuY2hhbm5lbC5idWxrRGVsZXRlKDEpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWxcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zZW5kKGBObyBtdXNpYyBjdXJyZW50bHkgcGxheWluZyAhYClcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChtc2cpID0+IG1zZy5kZWxldGUoeyB0aW1lb3V0OiAzMDAwIH0pKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcblxuICAgIGNsaWVudC5jbGVhckJhbm5lciA9IGFzeW5jIChjbGllbnQsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgbGV0IGNoYW5uZWwgPSBhd2FpdCBjbGllbnQuY2hhbm5lbHMuZmV0Y2goXG4gICAgICAgICAgICBtZXNzYWdlLnNldHRpbmdzLm11c2ljQ2hhbm5lbElkXG4gICAgICAgICk7XG4gICAgICAgIGxldCBtc2cgPSBhd2FpdCBjaGFubmVsLm1lc3NhZ2VzLmZldGNoKG1lc3NhZ2Uuc2V0dGluZ3MubXVzaWNNc2dJZCk7XG5cbiAgICAgICAgY29uc3QgZW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKClcbiAgICAgICAgICAgIC5zZXRUaXRsZSgnTm8gc29uZyBwbGF5aW5nIGN1cnJlbnRseScpXG4gICAgICAgICAgICAuc2V0SW1hZ2UoXG4gICAgICAgICAgICAgICAgJ2h0dHBzOi8vYmVzdGJvdHMudG9kYXkvd3AtY29udGVudC91cGxvYWRzLzIwMjAvMDQvTXVzaWMucG5nJ1xuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnNldEZvb3RlcihgUHJlZml4IGZvciB0aGlzIHNlcnZlciBpczogJHttZXNzYWdlLnNldHRpbmdzLnByZWZpeH1gKVxuICAgICAgICAgICAgLnNldENvbG9yKG1lc3NhZ2Uuc2V0dGluZ3MuZW1iZWRDb2xvcik7XG4gICAgICAgIG1zZy5lZGl0KCdRdWV1ZTpcXG4nLCBlbWJlZCk7XG4gICAgfTtcblxuICAgIGNsaWVudC5xdWV1ZU1lc3NhZ2UgPSAocXVldWUpID0+IHtcbiAgICAgICAgbGV0IHRleHQgPSAnUXVldWU6XFxuJztcbiAgICAgICAgZm9yIChsZXQgaSA9IHF1ZXVlLnRyYWNrcy5sZW5ndGggLSAxOyBpID49IDE7IGktLSkge1xuICAgICAgICAgICAgdGV4dCArPSBgJHtpfS4gJHtxdWV1ZS50cmFja3NbaV0udGl0bGV9XFxuYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9O1xuXG4gICAgY2xpZW50Lmx5cmljcyA9IGFzeW5jIChzb25nbmFtZSkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IGx5cmljcyA9IGF3YWl0IE11c2l4bWF0Y2guZmluZChzb25nbmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbHlyaWNzLmx5cmljcztcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmV0dXJuIGU7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgLyogTUlTQ0VMQU5FT1VTIE5PTi1DUklUSUNBTCBGVU5DVElPTlMgKi9cblxuICAgIC8vIEVYVEVORElORyBOQVRJVkUgVFlQRVMgSVMgQkFEIFBSQUNUSUNFLiBXaHk/IEJlY2F1c2UgaWYgSmF2YVNjcmlwdCBhZGRzIHRoaXNcbiAgICAvLyBsYXRlciwgdGhpcyBjb25mbGljdHMgd2l0aCBuYXRpdmUgY29kZS4gQWxzbywgaWYgc29tZSBvdGhlciBsaWIgeW91IHVzZSBkb2VzXG4gICAgLy8gdGhpcywgYSBjb25mbGljdCBhbHNvIG9jY3Vycy4gS05PV0lORyBUSElTIGhvd2V2ZXIsIHRoZSBmb2xsb3dpbmcgMiBtZXRob2RzXG4gICAgLy8gYXJlLCB3ZSBmZWVsLCB2ZXJ5IHVzZWZ1bCBpbiBjb2RlLlxuXG4gICAgLy8gPFN0cmluZz4udG9Qcm9wZXJjYXNlKCkgcmV0dXJucyBhIHByb3Blci1jYXNlZCBzdHJpbmcgc3VjaCBhczpcbiAgICAvLyBcIk1hcnkgaGFkIGEgbGl0dGxlIGxhbWJcIi50b1Byb3BlckNhc2UoKSByZXR1cm5zIFwiTWFyeSBIYWQgQSBMaXR0bGUgTGFtYlwiXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0cmluZy5wcm90b3R5cGUsICd0b1Byb3BlckNhc2UnLCB7XG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKFxuICAgICAgICAgICAgICAgIC8oW15cXFdfXStbXlxccy1dKikgKi9nLFxuICAgICAgICAgICAgICAgICh0eHQpID0+XG4gICAgICAgICAgICAgICAgICAgIHR4dC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoMSkudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIDxBcnJheT4ucmFuZG9tKCkgcmV0dXJucyBhIHNpbmdsZSByYW5kb20gZWxlbWVudCBmcm9tIGFuIGFycmF5XG4gICAgLy8gWzEsIDIsIDMsIDQsIDVdLnJhbmRvbSgpIGNhbiByZXR1cm4gMSwgMiwgMywgNCBvciA1LlxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShBcnJheS5wcm90b3R5cGUsICdyYW5kb20nLCB7XG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLmxlbmd0aCldO1xuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gYGF3YWl0IGNsaWVudC53YWl0KDEwMDApO2AgdG8gXCJwYXVzZVwiIGZvciAxIHNlY29uZC5cbiAgICBjbGllbnQud2FpdCA9IHJlcXVpcmUoJ3V0aWwnKS5wcm9taXNpZnkoc2V0VGltZW91dCk7XG5cbiAgICAvLyBUaGVzZSAyIHByb2Nlc3MgbWV0aG9kcyB3aWxsIGNhdGNoIGV4Y2VwdGlvbnMgYW5kIGdpdmUgKm1vcmUgZGV0YWlscyogYWJvdXQgdGhlIGVycm9yIGFuZCBzdGFjayB0cmFjZS5cbiAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKCFlcnIgfHwgIWVyci5zdGFjaykgcmV0dXJuO1xuICAgICAgICBjb25zdCBlcnJvck1zZyA9IGVyci5zdGFjay5yZXBsYWNlKFxuICAgICAgICAgICAgbmV3IFJlZ0V4cChgJHtfX2Rpcm5hbWV9L2AsICdnJyksXG4gICAgICAgICAgICAnLi8nXG4gICAgICAgICk7XG4gICAgICAgIGNsaWVudC5sb2dnZXIuZXJyb3IoYFVuY2F1Z2h0IEV4Y2VwdGlvbjogJHtlcnJvck1zZ31gKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAvLyBBbHdheXMgYmVzdCBwcmFjdGljZSB0byBsZXQgdGhlIGNvZGUgY3Jhc2ggb24gdW5jYXVnaHQgZXhjZXB0aW9ucy5cbiAgICAgICAgLy8gQmVjYXVzZSB5b3Ugc2hvdWxkIGJlIGNhdGNoaW5nIHRoZW0gYW55d2F5LlxuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfSk7XG5cbiAgICBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAoZXJyKSA9PiB7XG4gICAgICAgIGNsaWVudC5sb2dnZXIuZXJyb3IoYFVuaGFuZGxlZCByZWplY3Rpb246ICR7ZXJyfWApO1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgfSk7XG59O1xuIl19