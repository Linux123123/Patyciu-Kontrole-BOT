const fetch = require('node-fetch');
const entities = require('entities');
const validUrl = require('valid-url');
const { MessageEmbed } = require('discord.js');
exports.run = async (client, message, args, level) => {
    let lastPostName = '';
    let url;
    const command = message.content
        .slice(message.settings.prefix.length)
        .trim()
        .split(/ +/g)
        .shift()
        .toLowerCase();
    if (args < 1 && command != 'memes') {
        return message.reply('Must provide a subreddit! Derp.');
    }
    client.settings.set(message.guild.id, 'true', 'reddit');
    if (command == 'memes') {
        url = 'https://www.reddit.com/r/memes/new.json?limit=1';
    }
    else {
        url = `https://www.reddit.com/r/${args[0].toLowerCase()}/new.json?limit=1`;
    }
    const options = {
        responseEncoding: 'utf8',
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
        },
    };
    client.logger.log(`Retrieving reddit posts on ${message.guild.name} from r/${url.split('/')[4]}`);
    let intervalId = setInterval(() => {
        if (client.settings.get(message.guild.id, 'reddit') == 'false') {
            clearInterval(intervalId);
            throw 'Stopping reddit retrievals!';
        }
        fetch(url, options)
            .then((rawData) => {
            if (!rawData.ok) {
                message.reply('Error retrieving subreddit! Derp. Is it really a real one?');
                clearInterval(intervalId);
                throw 'Retrieving data from reddit failed! Stopping retrievals!';
            }
            else
                return rawData;
        })
            .then((rawData) => {
            let res = rawData.json();
            return res;
        })
            .then((res) => {
            if (res.data.after == null) {
                message.reply('Error retrieving subreddit! Derp. Is it really a real one?');
                clearInterval(intervalId);
                throw 'Retrieving data from reddit failed! Stopping retrievals!';
            }
            const post = res.data.children[0].data;
            if (post.name == lastPostName) {
                throw 'Alrd sent';
            }
            const embed = new MessageEmbed()
                .setTitle(`${post.link_flair_text
                ? `[${post.link_flair_text}] `
                : ''}${entities.decodeHTML(post.title)}`)
                .setURL(`https://redd.it/${post.id}`)
                .setDescription(`${post.is_self
                ? entities.decodeHTML(post.selftext.length > 253
                    ? post.selftext
                        .slice(0, 253)
                        .concat('...')
                    : post.selftext)
                : ''}`)
                .setImage(validUrl.isUri(post.url_overridden_by_dest)
                ? post.url_overridden_by_dest
                : null)
                .setFooter(`${post.is_self ? 'self post' : 'link post'} by ${post.author}`)
                .setColor(message.settings.embedColor)
                .setTimestamp(new Date(post.created_utc * 1000));
            message.channel.send(embed);
            lastPostName = post.name;
        })
            .catch((err) => {
            if (!(err == 'Alrd sent')) {
                client.settings.set(message.guild.id, 'false', 'reddit');
                client.logger.error(err);
            }
        });
    }, 2 * 1000); // 2 Seconds
};
exports.conf = {
    enabled: true,
    guildOnly: true,
    aliases: ['memes'],
    permLevel: 'Moderator',
};
exports.help = {
    name: 'reddit',
    category: 'Reddit',
    description: 'A subreddit in your channel!',
    usage: 'reddit subreddit\nmemes',
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkZGl0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbW1hbmRzL3JlZGRpdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN0QyxNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRS9DLE9BQU8sQ0FBQyxHQUFHLEdBQUcsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQ2pELElBQUksWUFBWSxHQUFHLEVBQUUsQ0FBQztJQUN0QixJQUFJLEdBQUcsQ0FBQztJQUNSLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPO1NBQzFCLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7U0FDckMsSUFBSSxFQUFFO1NBQ04sS0FBSyxDQUFDLEtBQUssQ0FBQztTQUNaLEtBQUssRUFBRTtTQUNQLFdBQVcsRUFBRSxDQUFDO0lBQ25CLElBQUksSUFBSSxHQUFHLENBQUMsSUFBSSxPQUFPLElBQUksT0FBTyxFQUFFO1FBQ2hDLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0tBQzNEO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRXhELElBQUksT0FBTyxJQUFJLE9BQU8sRUFBRTtRQUNwQixHQUFHLEdBQUcsaURBQWlELENBQUM7S0FDM0Q7U0FBTTtRQUNILEdBQUcsR0FBRyw0QkFBNEIsSUFBSSxD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QThCO0lBQzNDLEtBQUssRUFBRSx5QkFBeUI7Q0FDbkMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xuY29uc3QgZW50aXRpZXMgPSByZXF1aXJlKCdlbnRpdGllcycpO1xuY29uc3QgdmFsaWRVcmwgPSByZXF1aXJlKCd2YWxpZC11cmwnKTtcbmNvbnN0IHsgTWVzc2FnZUVtYmVkIH0gPSByZXF1aXJlKCdkaXNjb3JkLmpzJyk7XG5cbmV4cG9ydHMucnVuID0gYXN5bmMgKGNsaWVudCwgbWVzc2FnZSwgYXJncywgbGV2ZWwpID0+IHtcbiAgICBsZXQgbGFzdFBvc3ROYW1lID0gJyc7XG4gICAgbGV0IHVybDtcbiAgICBjb25zdCBjb21tYW5kID0gbWVzc2FnZS5jb250ZW50XG4gICAgICAgIC5zbGljZShtZXNzYWdlLnNldHRpbmdzLnByZWZpeC5sZW5ndGgpXG4gICAgICAgIC50cmltKClcbiAgICAgICAgLnNwbGl0KC8gKy9nKVxuICAgICAgICAuc2hpZnQoKVxuICAgICAgICAudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAoYXJncyA8IDEgJiYgY29tbWFuZCAhPSAnbWVtZXMnKSB7XG4gICAgICAgIHJldHVybiBtZXNzYWdlLnJlcGx5KCdNdXN0IHByb3ZpZGUgYSBzdWJyZWRkaXQhIERlcnAuJyk7XG4gICAgfVxuXG4gICAgY2xpZW50LnNldHRpbmdzLnNldChtZXNzYWdlLmd1aWxkLmlkLCAndHJ1ZScsICdyZWRkaXQnKTtcblxuICAgIGlmIChjb21tYW5kID09ICdtZW1lcycpIHtcbiAgICAgICAgdXJsID0gJ2h0dHBzOi8vd3d3LnJlZGRpdC5jb20vci9tZW1lcy9uZXcuanNvbj9saW1pdD0xJztcbiAgICB9IGVsc2Uge1xuICAgICAgICB1cmwgPSBgaHR0cHM6Ly93d3cucmVkZGl0LmNvbS9yLyR7YXJnc1swXS50b0xvd2VyQ2FzZSgpfS9uZXcuanNvbj9saW1pdD0xYDtcbiAgICB9XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICByZXNwb25zZUVuY29kaW5nOiAndXRmOCcsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgY2xpZW50LmxvZ2dlci5sb2coXG4gICAgICAgIGBSZXRyaWV2aW5nIHJlZGRpdCBwb3N0cyBvbiAke21lc3NhZ2UuZ3VpbGQubmFtZX0gZnJvbSByLyR7XG4gICAgICAgICAgICB1cmwuc3BsaXQoJy8nKVs0XVxuICAgICAgICB9YFxuICAgICk7XG4gICAgbGV0IGludGVydmFsSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIGlmIChjbGllbnQuc2V0dGluZ3MuZ2V0KG1lc3NhZ2UuZ3VpbGQuaWQsICdyZWRkaXQnKSA9PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpO1xuICAgICAgICAgICAgdGhyb3cgJ1N0b3BwaW5nIHJlZGRpdCByZXRyaWV2YWxzISc7XG4gICAgICAgIH1cbiAgICAgICAgZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgICAgICAgLnRoZW4oKHJhd0RhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXJhd0RhdGEub2spIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5yZXBseShcbiAgICAgICAgICAgICAgICAgICAgICAgICdFcnJvciByZXRyaWV2aW5nIHN1YnJlZGRpdCEgRGVycC4gSXMgaXQgcmVhbGx5IGEgcmVhbCBvbmU/J1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyAnUmV0cmlldmluZyBkYXRhIGZyb20gcmVkZGl0IGZhaWxlZCEgU3RvcHBpbmcgcmV0cmlldmFscyEnO1xuICAgICAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gcmF3RGF0YTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigocmF3RGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCByZXMgPSByYXdEYXRhLmpzb24oKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuYWZ0ZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnJlcGx5KFxuICAgICAgICAgICAgICAgICAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgc3VicmVkZGl0ISBEZXJwLiBJcyBpdCByZWFsbHkgYSByZWFsIG9uZT8nXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxJZCk7XG4gICAgICAgICAgICAgICAgICAgIHRocm93ICdSZXRyaWV2aW5nIGRhdGEgZnJvbSByZWRkaXQgZmFpbGVkISBTdG9wcGluZyByZXRyaWV2YWxzISc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHBvc3QgPSByZXMuZGF0YS5jaGlsZHJlblswXS5kYXRhO1xuICAgICAgICAgICAgICAgIGlmIChwb3N0Lm5hbWUgPT0gbGFzdFBvc3ROYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93ICdBbHJkIHNlbnQnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBlbWJlZCA9IG5ldyBNZXNzYWdlRW1iZWQoKVxuICAgICAgICAgICAgICAgICAgICAuc2V0VGl0bGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LmxpbmtfZmxhaXJfdGV4dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGBbJHtwb3N0LmxpbmtfZmxhaXJfdGV4dH1dIGBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfSR7ZW50aXRpZXMuZGVjb2RlSFRNTChwb3N0LnRpdGxlKX1gXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgLnNldFVSTChgaHR0cHM6Ly9yZWRkLml0LyR7cG9zdC5pZH1gKVxuICAgICAgICAgICAgICAgICAgICAuc2V0RGVzY3JpcHRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LmlzX3NlbGZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlbnRpdGllcy5kZWNvZGVIVE1MKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LnNlbGZ0ZXh0Lmxlbmd0aCA+IDI1M1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwb3N0LnNlbGZ0ZXh0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2xpY2UoMCwgMjUzKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNvbmNhdCgnLi4uJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogcG9zdC5zZWxmdGV4dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfWBcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAuc2V0SW1hZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxpZFVybC5pc1VyaShwb3N0LnVybF9vdmVycmlkZGVuX2J5X2Rlc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwb3N0LnVybF9vdmVycmlkZGVuX2J5X2Rlc3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGxcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAuc2V0Rm9vdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7cG9zdC5pc19zZWxmID8gJ3NlbGYgcG9zdCcgOiAnbGluayBwb3N0J30gYnkgJHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LmF1dGhvclxuICAgICAgICAgICAgICAgICAgICAgICAgfWBcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAuc2V0Q29sb3IobWVzc2FnZS5zZXR0aW5ncy5lbWJlZENvbG9yKVxuICAgICAgICAgICAgICAgICAgICAuc2V0VGltZXN0YW1wKG5ldyBEYXRlKHBvc3QuY3JlYXRlZF91dGMgKiAxMDAwKSk7XG4gICAgICAgICAgICAgICAgbWVzc2FnZS5jaGFubmVsLnNlbmQoZW1iZWQpO1xuICAgICAgICAgICAgICAgIGxhc3RQb3N0TmFtZSA9IHBvc3QubmFtZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghKGVyciA9PSAnQWxyZCBzZW50JykpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LnNldHRpbmdzLnNldChtZXNzYWdlLmd1aWxkLmlkLCAnZmFsc2UnLCAncmVkZGl0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5sb2dnZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9LCAyICogMTAwMCk7IC8vIDIgU2Vjb25kc1xufTtcblxuZXhwb3J0cy5jb25mID0ge1xuICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgZ3VpbGRPbmx5OiB0cnVlLFxuICAgIGFsaWFzZXM6IFsnbWVtZXMnXSxcbiAgICBwZXJtTGV2ZWw6ICdNb2RlcmF0b3InLFxufTtcblxuZXhwb3J0cy5oZWxwID0ge1xuICAgIG5hbWU6ICdyZWRkaXQnLFxuICAgIGNhdGVnb3J5OiAnUmVkZGl0JyxcbiAgICBkZXNjcmlwdGlvbjogJ0Egc3VicmVkZGl0IGluIHlvdXIgY2hhbm5lbCEnLFxuICAgIHVzYWdlOiAncmVkZGl0IHN1YnJlZGRpdFxcbm1lbWVzJyxcbn07XG4iXX0=